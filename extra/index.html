<!DOCTYPE html>
<!-- SPDX-License-Identifier: Apache-2.0 -->
<!-- 
     Copyright 2019-present Samsung Electronics France SAS, and other contributors
  -->
<html lang="en">
<head>
<meta charset="utf-8"/>
<script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
<title>TODO: replace URL to running instance (eg: localhost:8888)</title>
</head>
<body>
<a-scene>
<a-entity id="container" rotation="0 90 0">
<a-entity id="Torso">
<a-box color="#FF0000" scale="2 1 2">
</a-box>
<a-entity id="Shoulder" position="0 .5 0">
<a-cylinder scale=".4 .8 .4" rotation="0 0 90">
</a-cylinder>
<a-box color="#00FF00" scale=".7 3 .7" position="0 1 0">
</a-box>
<a-entity id="Arm" position="0 2.5 0">
<a-cylinder scale=".4 .8 .4" rotation="0 0 90">
</a-cylinder>
<a-box id="ArmBox" color="#0000FF" scale=".5 3 .5" position="0 1.5 0">
</a-box>
<a-entity id="Hand" position="0 1.5 0">
<a-cylinder scale=".4 .8 .4" rotation="0 0 0" position="0 1.6 0">
</a-cylinder>
<a-torus color="#43A367" arc="270" radius="1" radius-tubular="0.1"
 position="0 3 0" rotation="180 0 315">
</a-torus>
</a-entity>
</a-entity>
</a-entity>
</a-entity>
<a-camera position="0 2 5">
</a-camera>
</a-scene>
</body>

<script type="text/javascript">
var app = {
  pause: false,
  property: 'torso',
  url: 'https://webthing-iotjs-robot.glitch.me',
  suffix: '',
  useWs: false,
  wsUrl: 'ws://localhost:8888',
};

let interval = null;
let ws = null;

function verbose(arg)
{
  console.log(arg);
}

function update(properties)
{
  verbose(properties);
  document.title = properties;
  for (var property of Object.keys(properties)) {
   var rotation = [ 0, 0, 0];
    switch(property) {
      case "Torso":
      case "Hand":
         rotation[1] = properties[property];
      break;
    default:
      rotation[0] = properties[property];
    break;
  }
  var el =  document.getElementById(property);
  console.log(el.object3D);
  var position = JSON.parse(JSON.stringify(el.object3D.position));
  el.object3D.rotation.set(
    THREE.Math.degToRad(rotation[0]),
    THREE.Math.degToRad(rotation[1]),
    THREE.Math.degToRad(rotation[2]))
  }
}

function poll(delay)
{
  if (!delay) {
    delay = 1000;
  }
  interval = setInterval(() => {
    verbose(`log: loop: waiting delay: ${delay}`);
    var property = app.property;
    var url = `${app.url}/properties`;
    verbose(`log: fetch: ${url}`);
    if (app.pause) {
      verbose(`log: stopping: ${app.pause}`);
      inverval = clearInterval(interval);
    }
    fetch(url)
      .then((response) => {
        return response.json();
      }, (reason) => {
        verbose(reason);
        app.url = String(window.location)
          .substring(0, String(window.location).lastIndexOf("/"))
          + '/json';
        app.suffix = '/index.html';
        verbose(`log: Fallback to static: ${app.url}`);
      })
      .then((json) => {
        verbose(`log: payload: ${JSON.stringify(json)}`);
        update(json);
      });
  }, delay);
}

function start()
{
  let wsUrl = app.wsUrl.value;
  let useWebsockets = ("WebSocket" in window) && app.useWsl

  let searchParams = null;
  if (document.location.search) {
    searchParams = (new URL(document.location)).searchParams;
  }
  if (searchParams) {
    for (var entry of searchParams.entries())
      app[entry[0]] = entry[1];
  }

  if (useWebsockets) {
    ws = new WebSocket(wsUrl);
    ws.onclose = function (evt) {
      /// CLOSE_ABNORMAL
      if (evt.code === 1006) {
        poll();
      }
    }
    ws.onmessage = function (evt) {
      if (app.pause) {
        ws.close();
      }
      update(JSON.parse(evt.data).data);
    }
  } else {
    if (ws) ws.close();
    poll();
  }
}

function toggle(status)
{
  app.pause = status;
  if (status) {
    start();
  } else {
    if (ws) {
      ws.close();
      ws = null;
    }
    if (interval) {
      clearInterval(interval);
    }
  }
}

setTimeout(function() {
  start();
}, 1000);

</script>
</html>
